<!DOCTYPE html>
<html lang="en">

<head>
  <script>
    // Fixed Auth Guard - Only redirect from signin page
    (function () {
      const currentPath = window.location.pathname;

      // If we're on signin.html and user is logged in, redirect to index
      if (currentPath.includes('signin.html')) {
        const user = localStorage.getItem('kitsune_user');
        if (user) {
          window.location.href = 'index.html';
          return;
        }
      }

      // If we're NOT on signin.html and user is NOT logged in, redirect to signin
      if (!currentPath.includes('signin.html')) {
        const user = localStorage.getItem('kitsune_user');
        if (!user) {
          window.location.href = 'signin.html';
          return;
        }
      }

      // Store first login date in localStorage
      const firstLoginDate = localStorage.getItem('kitsune_first_login_date');
      if (!firstLoginDate) {
        const currentDate = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        localStorage.setItem('kitsune_first_login_date', currentDate);
      }

      // Initialize Theme from localStorage
      function initializeTheme() {
        const savedTheme = localStorage.getItem('kitsune_theme');
        if (savedTheme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
          document.body.classList.add('light-theme');
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          document.body.classList.remove('light-theme');
        }
      }

      initializeTheme();
    })();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitsune - Premium Anime Streaming</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== CSS RESET & BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* === DARK THEME COLORS === */
      --primary: #E50914;
      --primary-dark: #B20710;
      --primary-light: #FF4D4D;
      --secondary: #1A1A1A;
      --accent: #FF3333;
      --dark: #0F0F0F;
      --darker: #0A0A0A;
      --light: #F5F5F5;
      --gray: #8A8A8A;
      --card-bg: rgba(40, 40, 40, 0.8);
      --glass: rgba(255, 255, 255, 0.08);
      --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      --radius: 10px;
      --mobile-header-height: 60px;

      /* === LIGHT THEME COLORS === */
      --light-bg-primary: #FFFFFF;
      --light-bg-secondary: #F8F9FA;
      --light-bg-tertiary: #F1F3F5;
      --light-text-primary: #212529;
      --light-text-secondary: #495057;
      --light-text-tertiary: #868E96;
      --light-border-color: rgba(0, 0, 0, 0.1);
      --light-card-bg: rgba(248, 249, 250, 0.9);
      --light-card-border: rgba(0, 0, 0, 0.08);
      --light-glass: rgba(0, 0, 0, 0.05);
      --light-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    :root[data-theme="dark"] {
      --bg-primary: var(--darker);
      --bg-secondary: var(--dark);
      --bg-tertiary: var(--secondary);
      --text-primary: var(--light);
      --text-secondary: rgba(255, 255, 255, 0.8);
      --text-tertiary: var(--gray);
      --border-color: rgba(255, 255, 255, 0.1);
      --card-bg-color: var(--card-bg);
      --card-border: rgba(255, 255, 255, 0.05);
      --input-bg: rgba(255, 255, 255, 0.15);
      --input-border: rgba(255, 0, 0, 0.2);
      --input-text: #FFFFFF;
      --glass-color: var(--glass);
      --current-shadow: var(--shadow);
      --footer-bg: var(--darker);
    }

    :root[data-theme="light"] {
      --bg-primary: var(--light-bg-primary);
      --bg-secondary: var(--light-bg-secondary);
      --bg-tertiary: var(--light-bg-tertiary);
      --text-primary: var(--light-text-primary);
      --text-secondary: var(--light-text-secondary);
      --text-tertiary: var(--light-text-tertiary);
      --border-color: var(--light-border-color);
      --card-bg-color: var(--light-card-bg);
      --card-border: var(--light-card-border);
      --input-bg: var(--light-input-bg);
      --input-border: var(--light-input-border);
      --input-text: var(--light-text-primary);
      --glass-color: var(--light-glass);
      --current-shadow: var(--light-shadow);
      --footer-bg: var(--light-bg-secondary);
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ===== TYPOGRAPHY ===== */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 1rem;
    }

    h1 {
      font-size: 3.5rem;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    h2 {
      font-size: 2.2rem;
      position: relative;
      display: inline-block;
      color: var(--primary-light);
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 0;
      width: 60px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }

    h3 {
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    p {
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
    }

    /* ===== LAYOUT COMPONENTS ===== */
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    section {
      padding: 60px 0;
    }

    .section-header {
      margin-bottom: 40px;
    }

    .section-header h2 {
      font-size: 2.2rem;
    }

    .section-header p {
      font-size: 1.1rem;
      max-width: 600px;
    }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 28px;
      border-radius: 50px;
      font-weight: 600;
      text-decoration: none;
      transition: var(--transition);
      border: none;
      cursor: pointer;
      font-size: 1rem;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(229, 9, 20, 0.6);
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--glass-color);
      transform: translateY(-3px);
      border-color: rgba(229, 9, 20, 0.3);
    }

    .btn-lg {
      padding: 14px 36px;
      font-size: 1.1rem;
    }

    /* ===== HEADER & NAVIGATION ===== */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      padding: 18px 0;
      transition: var(--transition);
      background: rgba(15, 15, 15, 0.4) !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    :root[data-theme="light"] header {
      background: rgba(255, 255, 255, 0.5) !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }


    header.scrolled {
      background: rgba(15, 15, 15, 0.7) !important;
      backdrop-filter: blur(25px) saturate(200%) !important;
      -webkit-backdrop-filter: blur(25px) saturate(200%) !important;
      border-bottom: 1px solid rgba(229, 9, 20, 0.2);
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 900;
      font-size: 1.4rem;
      box-shadow: 0 4px 12px rgba(229, 9, 20, 0.4);
    }

    .logo-text {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--primary);
      text-shadow: 0 2px 8px rgba(229, 9, 20, 0.3);
    }

    .nav-links {
      display: flex;
      gap: 30px;
      list-style: none;
    }

    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
      position: relative;
    }

    .nav-links a:hover {
      color: var(--primary-light);
    }

    .nav-links a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--primary);
      transition: var(--transition);
    }

    .nav-links a:hover::after {
      width: 100%;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    /* ===== THEME TOGGLE SWITCH ===== */
    .theme-toggle-container {
      display: flex;
      align-items: center;
      margin-right: 5px;
    }

    .theme-toggle-checkbox {
      display: none;
    }

    .theme-toggle-label {
      position: relative;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
      width: 50px;
      height: 26px;
      background: var(--glass-color);
      border-radius: 50px;
      border: 1px solid var(--border-color);
      padding: 2px;
      transition: var(--transition);
    }

    .theme-toggle-label:hover {
      border-color: var(--primary);
    }

    .theme-toggle-slider {
      position: absolute;
      width: 22px;
      height: 22px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      left: 2px;
    }

    .theme-toggle-checkbox:checked+.theme-toggle-label .theme-toggle-slider {
      transform: translateX(24px);
      background: #FFD700;
    }

    .theme-toggle-icon {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0 5px;
      pointer-events: none;
    }

    .theme-toggle-icon i {
      font-size: 0.7rem;
      transition: var(--transition);
    }

    .theme-toggle-icon .fa-moon {
      color: #FFD700;
    }

    .theme-toggle-icon .fa-sun {
      color: #FFA500;
    }

    .theme-toggle-checkbox:checked+.theme-toggle-label .fa-moon {
      opacity: 0.5;
    }

    .theme-toggle-checkbox:not(:checked)+.theme-toggle-label .fa-sun {
      opacity: 0.5;
    }

    /* ===== FIXED: SEARCH ICON & EXPANDING SEARCH BAR STYLES ===== */
    .search-container {
      position: relative;
      display: flex;
      align-items: center;
    }

    /* Search Icon Button - HIDDEN WHEN SEARCH BAR IS EXPANDED */
    .search-icon-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      z-index: 10;
    }

    /* FIXED: Hide search icon button when search box is expanded */
    .search-icon-btn.hidden {
      opacity: 0;
      visibility: hidden;
      width: 0;
      padding: 0;
      margin: 0;
    }

    .search-icon-btn:hover {
      color: var(--primary-light);
      transform: scale(1.05);
    }

    .search-icon-btn.active {
      color: var(--primary);
    }

    .search-icon-btn i {
      transition: var(--transition);
    }

    /* Expanding Search Box */
    .search-box {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      width: 0;
      height: 40px;
      overflow: hidden;
      transition: var(--transition);
      border-radius: 50px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      opacity: 0;
      visibility: hidden;
      z-index: 9;
    }

    .search-box.expanded {
      width: 300px;
      background: var(--bg-tertiary);
      border: 1px solid var(--input-border);
      opacity: 1;
      visibility: visible;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      z-index: 1001;
    }

    :root[data-theme="light"] .search-box.expanded {
      background: var(--light-bg-primary);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .search-box input {
      width: 100%;
      padding: 0 45px 0 20px;
      border: none;
      background: transparent;
      color: var(--input-text);
      font-family: inherit;
      font-size: 0.95rem;
      transition: var(--transition);
      outline: none;
      flex: 1;
      opacity: 0;
    }

    .search-box.expanded input {
      opacity: 1;
      padding: 10px 45px 10px 20px;
    }

    /* Search Close Button INSIDE search box - Always visible when expanded */
    .search-close-btn {
      position: absolute;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      display: none;
      z-index: 11;
    }

    .search-box.expanded .search-close-btn {
      display: block;
      opacity: 1;
    }

    .search-close-btn:hover {
      color: var(--primary);
    }

    /* Search Results Dropdown */
    .search-results {
      position: absolute;
      top: 100%;
      right: 0;
      width: 400px;
      max-width: 90vw;
      background: var(--bg-tertiary);
      border-radius: 12px;
      box-shadow: var(--current-shadow);
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
      z-index: 1001;
      display: none;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }

    .search-results.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ===== SEARCH RESULT RATINGS STYLING ===== */
    .search-result-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      gap: 10px;
    }

    .search-result-genre {
      font-size: 0.8rem;
      color: var(--text-tertiary);
      flex: 1;
    }

    .search-result-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #FFD700;
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .search-result-rating i {
      font-size: 0.7rem;
    }

    /* Update search result content layout */
    .search-result-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .search-result-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .search-result-type {
      font-size: 0.8rem;
      color: var(--primary);
      margin-bottom: 3px;
    }

    /* Ensure search result items have proper spacing */
    .search-result-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      color: inherit;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: rgba(229, 9, 20, 0.1);
    }

    .search-result-image {
      width: 50px;
      height: 70px;
      border-radius: 6px;
      overflow: hidden;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .search-result-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: var(--text-tertiary);
    }

    .user-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* Profile Button */
    .profile-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--glass-color);
      border: 1px solid var(--border-color);
      border-radius: 50px;
      padding: 6px 12px 6px 6px;
      color: var(--text-primary);
      text-decoration: none;
      transition: var(--transition);
      cursor: pointer;
    }

    .profile-btn:hover {
      background: rgba(229, 9, 20, 0.2);
      border-color: rgba(229, 9, 20, 0.3);
    }

    .profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      overflow: hidden;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
    }

    .hamburger span {
      width: 25px;
      height: 3px;
      background: var(--text-primary);
      border-radius: 2px;
      transition: var(--transition);
    }

    /* ===== CHANGE 1: ANIME CAROUSEL STYLES ===== */
    .anime-carousel-container {
      position: relative;
      width: 100%;
      height: 400px;
      margin-bottom: 40px;
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--bg-tertiary);
    }

    .anime-carousel {
      display: flex;
      height: 100%;
      transition: transform 0.5s ease;
      touch-action: pan-y;
      user-select: none;
    }

    .carousel-slide {
      min-width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 40px;
      position: relative;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, rgba(20, 20, 20, 0.7) 100%);
    }

    :root[data-theme="light"] .carousel-slide {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(240, 240, 240, 0.8) 100%);
    }

    .carousel-image {
      width: 250px;
      height: 350px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--current-shadow);
      flex-shrink: 0;
      margin-right: 40px;
      position: relative;
      z-index: 2;
    }

    .carousel-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .carousel-content {
      max-width: 600px;
      position: relative;
      z-index: 2;
    }

    .carousel-content h3 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--text-primary);
    }

    .carousel-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }

    .carousel-rating {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #FFD700;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .carousel-episode {
      background: var(--primary);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .carousel-description {
      font-size: 1.1rem;
      line-height: 1.6;
      color: var(--text-secondary);
      margin-bottom: 25px;
      max-height: 120px;
      overflow: hidden;
    }

    .carousel-badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      z-index: 3;
    }

    .carousel-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      filter: blur(10px);
      opacity: 0.3;
      z-index: 1;
    }

    :root[data-theme="light"] .carousel-backdrop {
      opacity: 0.2;
    }

    /* Carousel auto-slide indicator */
    .carousel-progress {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 3;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    :root[data-theme="light"] .progress-dot {
      background: rgba(0, 0, 0, 0.3);
    }

    .progress-dot.active {
      background: var(--primary);
      transform: scale(1.2);
    }

    /* Mobile responsive for carousel */
    @media (max-width: 992px) {
      .anime-carousel-container {
        height: 350px;
      }

      .carousel-slide {
        flex-direction: column;
        justify-content: center;
        text-align: center;
        padding: 20px;
      }

      .carousel-image {
        width: 180px;
        height: 250px;
        margin-right: 0;
        margin-bottom: 20px;
      }

      .carousel-content h3 {
        font-size: 2rem;
      }

      .carousel-description {
        font-size: 1rem;
        max-height: 90px;
      }
    }

    @media (max-width: 768px) {

      /* ===== FIXED: MOBILE CAROUSEL - POSTER WITH GRADIENT OVERLAY ===== */
      .anime-carousel-container {
        height: 320px;
        border-radius: 16px;
        margin: 10px 0 25px;
        overflow: hidden;
      }

      .carousel-slide {
        flex-direction: column;
        padding: 0;
        background: none;
        position: relative;
      }

      /* Remove blur backdrop for mobile */
      .carousel-backdrop {
        display: none;
      }

      /* Carousel image takes full height with gradient overlay */
      .carousel-image {
        width: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0;
        position: relative;
      }

      .carousel-image::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70%;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
      }

      :root[data-theme="light"] .carousel-image::after {
        background: linear-gradient(to top, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.5) 50%, transparent 100%);
      }

      .carousel-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Content positioned at bottom */
      .carousel-content {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        padding: 0 20px;
        z-index: 3;
        text-align: left;
      }

      .carousel-content h3 {
        font-size: 1.6rem;
        margin-bottom: 10px;
        color: var(--text-primary);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      .carousel-meta {
        flex-direction: row;
        gap: 15px;
        margin-bottom: 15px;
      }

      .carousel-rating {
        font-size: 1rem;
        color: #FFD700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      }

      .carousel-episode {
        font-size: 0.85rem;
        padding: 4px 10px;
      }

      .carousel-description {
        display: none;
        /* Hide description on mobile */
      }

      .carousel-badge {
        top: 15px;
        right: 15px;
        z-index: 4;
      }

      /* Progress dots at bottom */
      .carousel-progress {
        bottom: 10px;
        z-index: 4;
      }
    }

    @media (max-width: 576px) {
      .anime-carousel-container {
        height: 280px;
      }

      .carousel-content h3 {
        font-size: 1.4rem;
      }

      .carousel-meta {
        gap: 10px;
      }

      .carousel-rating {
        font-size: 0.9rem;
      }

      .carousel-badge {
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        font-size: 0.8rem;
      }
    }

    /* ===== PROFILE MODAL ===== */
    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .profile-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .profile-content {
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      padding: 30px;
      width: 90%;
      max-width: 400px;
      box-shadow: var(--current-shadow);
      border: 1px solid var(--border-color);
      position: relative;
    }

    .profile-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .profile-close:hover {
      color: var(--primary);
    }

    .profile-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .profile-image-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
    }

    .profile-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary);
      background: var(--card-bg-color);
    }

    .profile-image-edit {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      border: 2px solid var(--bg-tertiary);
      transition: var(--transition);
    }

    .profile-image-edit:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }

    .profile-image-input {
      display: none;
    }

    .profile-details {
      margin-bottom: 25px;
    }

    .profile-field {
      margin-bottom: 15px;
    }

    .profile-label {
      display: block;
      color: var(--text-tertiary);
      font-size: 0.8rem;
      margin-bottom: 5px;
    }

    .profile-value {
      color: var(--text-primary);
      font-weight: 500;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .profile-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .btn-signout {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .btn-signout:hover {
      background: var(--primary);
      color: white;
    }

    /* ===== HERO CAROUSEL SECTION (MOVED BEFORE TODAY'S RELEASES) ===== */
    .hero-carousel-section {
      padding-top: 120px;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
    }

    /* ===== CONTINUE WATCHING SECTION ===== */
    .continue-watching-section {
      background: var(--bg-tertiary);
      position: relative;
    }

    .continue-watching-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .continue-watching-header h2 {
      font-size: 2.5rem;
      margin: 0;
    }

    .continue-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .delete-history-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-tertiary);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .delete-history-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .continue-view-all {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .continue-view-all:hover {
      color: var(--primary-light);
      transform: translateX(5px);
    }

    .continue-view-less {
      display: none;
    }

    /* Continue Watching Grid - HORIZONTAL SCROLL ON MOBILE */
    .continue-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      transition: all 0.3s ease;
    }

    .continue-grid.expanded {
      grid-template-columns: repeat(6, 1fr);
    }

    .continue-card {
      background: var(--card-bg-color);
      border-radius: var(--radius);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid var(--card-border);
      position: relative;
      cursor: pointer;
    }

    .continue-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--current-shadow);
      border-color: rgba(229, 9, 20, 0.3);
    }

    .continue-image {
      height: 220px;
      overflow: hidden;
      position: relative;
    }

    .continue-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }

    .continue-card:hover .continue-image img {
      transform: scale(1.05);
    }

    .continue-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      z-index: 2;
    }

    .continue-progress-bar {
      height: 100%;
      background: var(--primary);
      width: 0%;
    }

    .continue-content {
      padding: 15px;
    }

    .continue-content h3 {
      font-size: 1rem;
      margin-bottom: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }

    .continue-episode {
      font-size: 0.8rem;
      color: var(--primary);
      margin-bottom: 5px;
      font-weight: 600;
    }

    .continue-time {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.7rem;
      color: var(--text-tertiary);
    }

    .continue-time i {
      color: var(--primary);
      font-size: 0.6rem;
    }

    @media (max-width: 1400px) {
      .continue-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .continue-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 992px) {
      .continue-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ===== TODAY'S RELEASES SECTION (MOVED AFTER CAROUSEL) ===== */
    .today-releases-section {
      background: var(--bg-secondary);
      position: relative;
    }

    .today-releases-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .today-releases-header h2 {
      font-size: 2.5rem;
      margin: 0;
    }

    .view-all {
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .view-all:hover {
      color: var(--primary-light);
      transform: translateX(5px);
    }

    /* Hide view less initially */
    .view-less {
      display: none;
    }

    /* ===== ANIME SECTIONS ===== */
    .anime-section {
      background: var(--bg-tertiary);
      position: relative;
    }

    .anime-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 20px;
      transition: all 0.3s ease;
    }

    .anime-grid.expanded {
      grid-template-columns: repeat(6, 1fr);
    }

    .anime-card {
      background: var(--card-bg-color);
      border-radius: var(--radius);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid var(--card-border);
      position: relative;
      cursor: pointer;
    }

    .anime-card:hover {
      transform: translateY(-8px);
      box-shadow: var(--current-shadow);
      border-color: rgba(229, 9, 20, 0.3);
    }

    .card-image {
      height: 220px;
      overflow: hidden;
      position: relative;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }

    .anime-card:hover .card-image img {
      transform: scale(1.05);
    }

    .card-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      z-index: 2;
    }

    .card-content {
      padding: 15px;
    }

    .card-content h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--text-primary);
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }

    .card-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #FFD700;
      font-size: 0.8rem;
    }

    .card-description {
      color: var(--text-secondary);
      font-size: 0.8rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      max-height: 2.8em;
    }

    /* ===== TRENDING NOW SECTION ===== */
    .trending-now {
      position: relative;
      overflow: hidden;
    }

    .trending-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .section-controls {
      display: flex;
      gap: 12px;
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--glass-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }

    .control-btn:hover {
      background: var(--primary);
      color: white;
    }

    .trending-slider {
      display: flex;
      gap: 18px;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding: 10px 5px;
      scrollbar-width: none;
    }

    .trending-slider::-webkit-scrollbar {
      display: none;
    }

    .trending-item {
      min-width: 200px;
      background: var(--card-bg-color);
      border-radius: var(--radius);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid var(--card-border);
    }

    .trending-item:hover {
      transform: translateY(-5px);
      box-shadow: var(--current-shadow);
    }

    .trending-image {
      height: 140px;
      overflow: hidden;
    }

    .trending-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: var(--transition);
    }

    .trending-item:hover .trending-image img {
      transform: scale(1.05);
    }

    .trending-content {
      padding: 15px;
    }

    .trending-content h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trending-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-tertiary);
      margin-bottom: 8px;
    }

    /* ===== GENRES SECTION ===== */
    .genres {
      background: var(--bg-secondary);
    }

    .genres-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 18px;
    }

    .genre-card {
      background: linear-gradient(135deg, var(--card-bg-color) 0%, rgba(50, 50, 50, 0.7) 100%);
      border-radius: var(--radius);
      padding: 25px 15px;
      text-align: center;
      transition: var(--transition);
      border: 1px solid var(--card-border);
      cursor: pointer;
    }

    :root[data-theme="light"] .genre-card {
      background: linear-gradient(135deg, var(--card-bg-color) 0%, rgba(220, 220, 220, 0.7) 100%);
    }

    .genre-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--current-shadow);
      border-color: var(--primary);
    }

    .genre-icon {
      font-size: 2.2rem;
      margin-bottom: 12px;
      color: var(--primary);
    }

    .genre-card h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
    }

    .genre-count {
      color: var(--text-tertiary);
      font-size: 0.85rem;
    }

    /* ===== FOOTER ===== */
    footer {
      background: var(--footer-bg);
      padding: 60px 0 25px;
      border-top: 1px solid var(--border-color);
    }

    .footer-content {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 40px;
      margin-bottom: 40px;
    }

    .footer-column h3 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      position: relative;
      padding-bottom: 10px;
      color: var(--primary-light);
    }

    .footer-column h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 40px;
      height: 3px;
      background: var(--primary);
      border-radius: 2px;
    }

    .footer-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .footer-logo .logo-icon {
      width: 35px;
      height: 35px;
      font-size: 1rem;
    }

    .footer-logo .logo-text {
      font-size: 1.5rem;
    }

    .footer-about p {
      margin-bottom: 20px;
      color: var(--text-secondary);
    }

    .social-links {
      display: flex;
      gap: 15px;
    }

    .social-links a {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--glass-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      text-decoration: none;
      transition: var(--transition);
    }

    .social-links a:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-3px);
    }

    .footer-links {
      list-style: none;
    }

    .footer-links li {
      margin-bottom: 12px;
    }

    .footer-links a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: var(--transition);
    }

    .footer-links a:hover {
      color: var(--primary);
      padding-left: 5px;
    }

    .footer-bottom {
      text-align: center;
      padding-top: 25px;
      border-top: 1px solid var(--border-color);
      color: var(--text-tertiary);
      font-size: 0.9rem;
    }

    .updated-badge {
      background: #FF6B00;
      /* Orange for new episodes */
    }

    .new-badge {
      background: var(--primary);
      /* Red for new anime */
    }

    .search-update-indicator {
      display: inline-block;
      background: #FF6B00;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      margin-left: 8px;
      font-weight: 600;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 1400px) {
      .anime-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .today-releases-header h2 {
        font-size: 2.2rem;
      }

      .footer-content {
        grid-template-columns: 1fr 1fr 1fr;
      }

      .footer-about {
        grid-column: 1 / -1;
        margin-bottom: 30px;
      }

      .anime-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .search-box.expanded {
        width: 250px;
      }
    }

    @media (max-width: 992px) {
      h1 {
        font-size: 2.5rem;
      }

      h2 {
        font-size: 2rem;
      }

      .nav-links {
        gap: 20px;
      }

      .today-releases-header h2 {
        font-size: 2rem;
      }

      .footer-content {
        grid-template-columns: 1fr 1fr;
      }

      .anime-grid {
        grid-template-columns: repeat(3, 1fr);
      }

      .search-box.expanded {
        width: 220px;
      }
    }

    /* ===== MOBILE SPECIFIC CHANGES (768px and below) ===== */
    @media (max-width: 768px) {

      /* Existing modern mobile header/app styles (kept as is) */
      body {
        background: var(--bg-primary) !important;
        font-size: 14px;
        -webkit-tap-highlight-color: transparent;
        padding-bottom: env(safe-area-inset-bottom);
      }

      header {
        background: rgba(var(--bg-primary-rgb, 0, 0, 0), 0.95) !important;
        backdrop-filter: blur(20px);
        padding: 0 !important;
        height: var(--mobile-header-height);
        border-bottom: 1px solid var(--border-color);
      }

      .navbar {
        height: var(--mobile-header-height);
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
      }

      .logo {
        gap: 10px;
      }

      .logo-icon {
        width: 36px;
        height: 36px;
        border-radius: 9px;
      }

      .logo-text {
        font-size: 1.4rem;
      }

      .nav-links {
        display: none !important;
      }

      .theme-toggle-container {
        margin-right: 8px;
      }

      .theme-toggle-label {
        width: 46px;
        height: 24px;
      }

      .theme-toggle-slider {
        width: 20px;
        height: 20px;
      }

      .theme-toggle-checkbox:checked+.theme-toggle-label .theme-toggle-slider {
        transform: translateX(22px);
      }

      /* Search container adjustments from existing mobile code */
      .search-container {
        position: static;
      }

      .search-icon-btn {
        display: flex !important;
        background: transparent !important;
        border: none !important;
        width: 40px;
        height: 40px;
      }

      .search-icon-btn.hidden {
        opacity: 0 !important;
        visibility: hidden !important;
        width: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
      }

      .search-box {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: var(--mobile-header-height);
        background: rgba(var(--bg-primary), 0.98) !important;
        backdrop-filter: blur(20px);
        border-radius: 0 !important;
        border: none !important;
        border-bottom: 1px solid var(--border-color);
        transform: none !important;
        opacity: 0;
        visibility: hidden;
        z-index: 1002;
        padding: 0 16px;
        display: flex;
        align-items: center;
      }

      .search-box.expanded {
        opacity: 1;
        visibility: visible;
      }

      .search-box input {
        opacity: 1 !important;
        padding: 12px 45px 12px 16px !important;
        font-size: 16px;
      }

      .search-close-btn {
        display: block !important;
        opacity: 1 !important;
        right: 20px;
        font-size: 1.2rem;
        width: 40px;
        height: 40px;
      }

      .search-results {
        position: fixed !important;
        top: var(--mobile-header-height) !important;
        left: 0 !important;
        width: 100% !important;
        height: calc(100vh - var(--mobile-header-height)) !important;
        max-height: none !important;
        border-radius: 0 !important;
        border: none !important;
        border-top: 1px solid var(--border-color);
        background: rgba(var(--bg-tertiary), 0.98) !important;
        backdrop-filter: blur(20px);
        margin-top: 0 !important;
        z-index: 1001;
      }

      .user-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .profile-btn {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
      }

      .profile-avatar {
        width: 40px !important;
        height: 40px !important;
      }

      .profile-name {
        display: none;
      }

      .hamburger {
        display: none !important;
      }

      .hero-carousel-section {
        padding-top: calc(var(--mobile-header-height) + 20px) !important;
        padding-bottom: 20px !important;
      }

      section {
        padding: 30px 0 !important;
      }

      .container {
        padding: 0 16px;
      }

      /* ===== MOBILE GRID & SCROLL CHANGES (Your requested modifications) ===== */

      /* 1. Anime cards show only poster and name (hide meta, rating, description) */
      .anime-card .card-meta,
      .anime-card .card-description,
      .continue-card .continue-episode,
      .continue-card .continue-time {
        display: none !important;
      }

      .anime-card .card-content {
        padding: 8px 5px;
      }

      .anime-card .card-content h3 {
        font-size: 0.85rem;
        text-align: center;
        margin-bottom: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* 2. Today's Releases & Continue Watching: single row with horizontal scroll */
      #todayReleasesGrid.anime-grid,
      #continueGrid.continue-grid {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        gap: 12px;
        padding-bottom: 8px;
        scrollbar-width: thin;
        grid-template-columns: unset !important;
        /* Override grid */
      }

      #todayReleasesGrid.anime-grid::-webkit-scrollbar,
      #continueGrid.continue-grid::-webkit-scrollbar {
        height: 4px;
      }

      #todayReleasesGrid.anime-grid::-webkit-scrollbar-thumb,
      #continueGrid.continue-grid::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
      }

      /* Each card in the scrolling row has fixed width */
      #todayReleasesGrid.anime-grid .anime-card,
      #continueGrid.continue-grid .continue-card {
        flex: 0 0 120px;
        min-width: 120px;
        max-width: 120px;
      }

      /* Adjust card image height for mobile scrolling cards */
      #todayReleasesGrid.anime-grid .anime-card .card-image,
      #continueGrid.continue-grid .continue-card .continue-image {
        height: 160px;
      }

      /* 3. Featured Anime Grid remains unchanged (3 columns, no scroll) */
      #featuredAnimeGrid.anime-grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 12px;
        overflow-x: visible;
      }

      #featuredAnimeGrid.anime-grid .anime-card {
        flex: unset;
        min-width: unset;
        max-width: unset;
      }

      #featuredAnimeGrid.anime-grid .anime-card .card-image {
        height: 160px;
      }

      /* Adjust genre grid for mobile */
      .genres-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .genre-card {
        padding: 20px 10px;
      }

      footer {
        padding: 40px 0 30px;
      }

      .footer-content {
        grid-template-columns: 1fr;
        gap: 30px;
      }

      .section-header h2 {
        font-size: 1.8rem !important;
      }

      .today-releases-header h2 {
        font-size: 1.8rem !important;
      }

      .today-releases-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .search-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 999;
        backdrop-filter: blur(5px);
      }

      .search-backdrop.active {
        display: block;
      }
    }

    /* ===== EXTRA SMALL DEVICES ===== */
    @media (max-width: 380px) {
      :root {
        --mobile-header-height: 56px;
      }

      .navbar {
        padding: 0 12px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
      }

      .logo-text {
        font-size: 1.2rem;
      }

      .theme-toggle-label {
        width: 42px;
        height: 22px;
      }

      .theme-toggle-slider {
        width: 18px;
        height: 18px;
      }

      .theme-toggle-checkbox:checked+.theme-toggle-label .theme-toggle-slider {
        transform: translateX(20px);
      }

      .search-icon-btn {
        width: 36px;
        height: 36px;
      }

      .profile-avatar {
        width: 36px !important;
        height: 36px !important;
      }

      #todayReleasesGrid.anime-grid .anime-card,
      #continueGrid.continue-grid .continue-card {
        flex: 0 0 100px;
        min-width: 100px;
      }

      #featuredAnimeGrid.anime-grid {
        grid-template-columns: repeat(3, 1fr) !important;
      }

      .genres-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Desktop: Hide search close button in search icon */
    @media (min-width: 769px) {
      .search-icon-btn.active i {
        transform: none !important;
      }

      .search-icon-btn i {
        font-family: "Font Awesome 6 Free" !important;
        font-weight: 900 !important;
      }

      .search-close-btn {
        display: none;
      }

      .search-box.expanded .search-close-btn {
        display: block;
        opacity: 1;
      }
    }

    /* ===== TOAST NOTIFICATION ===== */
    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--primary);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      box-shadow: var(--current-shadow);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      font-weight: 500;
      pointer-events: none;
    }

    .toast-notification.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .toast-notification i {
      font-size: 1.2rem;
    }

    .toast-notification.success {
      background: #4CAF50;
    }

    .toast-notification.error {
      background: #f44336;
    }

    .toast-notification.info {
      background: var(--primary);
    }

    @media (max-width: 768px) {
      .toast-notification {
        bottom: 20px;
        right: 20px;
        left: 20px;
        width: auto;
        border-radius: 30px;
      }
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header id="header">
    <div class="container">
      <nav class="navbar">
        <a href="#" class="logo">
          <div class="logo-icon">
            <img src="Image & logo/kitsune logo.jpg" alt="Kitsune Logo"
              style="width: 100%; height: 100%; object-fit: contain;">
          </div>
          <div class="logo-text">Kitsune</div>
        </a>

        <ul class="nav-links">
          <li><a href="#home">Home</a></li>
          <li><a href="#hero-carousel">Featured</a></li>
          <li><a href="#continue-watching">Continue</a></li>
          <li><a href="#today-releases">Today's Releases</a></li>
          <li><a href="#genres">Genres</a></li>
        </ul>

        <div class="nav-actions">
          <!-- Theme Toggle Switch -->
          <div class="theme-toggle-container">
            <input type="checkbox" id="themeToggle" class="theme-toggle-checkbox">
            <label for="themeToggle" class="theme-toggle-label">
              <span class="theme-toggle-slider"></span>
              <span class="theme-toggle-icon">
                <i class="fas fa-moon"></i>
                <i class="fas fa-sun"></i>
              </span>
            </label>
          </div>

          <!-- Toast Notification -->
          <div class="toast-notification" id="toastNotification">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Watch history deleted</span>
          </div>

          <!-- Search Container -->
          <div class="search-container">
            <button class="search-icon-btn" id="searchIconBtn">
              <i class="fas fa-search"></i>
            </button>

            <div class="search-box" id="searchBox">
              <input type="text" id="searchInput" placeholder="Search anime...">
              <button class="search-close-btn" id="searchCloseBtn">
                <i class="fas fa-times"></i>
              </button>
            </div>

            <div class="search-results" id="searchResults"></div>
          </div>

          <div class="user-actions">
            <a href="#" class="profile-btn" id="profileBtn">
              <div class="profile-avatar" id="profileAvatar">
                <i class="fas fa-user"></i>
              </div>
              <span class="profile-name">User</span>
            </a>
          </div>

          <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- Search Backdrop for Mobile -->
  <div class="search-backdrop" id="searchBackdrop"></div>

  <!-- Profile Modal -->
  <div class="profile-modal" id="profileModal">
    <div class="profile-content">
      <button class="profile-close" id="profileClose">
        <i class="fas fa-times"></i>
      </button>

      <div class="profile-header">
        <div class="profile-image-container">
          <img src="" alt="Profile" class="profile-image" id="profileImage">
          <div class="profile-image-edit" id="profileImageEdit">
            <i class="fas fa-camera"></i>
          </div>
          <input type="file" id="profileImageInput" class="profile-image-input" accept="image/*">
        </div>
        <h2 id="profileDisplayName">User Name</h2>
      </div>

      <div class="profile-details">
        <div class="profile-field">
          <div class="profile-label">Username</div>
          <div class="profile-value" id="profileUsername">@username</div>
        </div>
        <div class="profile-field">
          <div class="profile-label">Email</div>
          <div class="profile-value" id="profileEmail">user@example.com</div>
        </div>
        <div class="profile-field">
          <div class="profile-label">Member Since</div>
          <div class="profile-value" id="profileJoinDate">January 2023</div>
        </div>
      </div>

      <div class="profile-actions">
        <button class="btn-signout" id="signOutBtn">
          <i class="fas fa-sign-out-alt"></i>
          Sign Out
        </button>
      </div>
    </div>
  </div>

  <!-- Hero Carousel Section -->
  <section class="hero-carousel-section" id="hero-carousel">
    <div class="container">
      <div class="anime-carousel-container" id="animeCarouselContainer">
        <div class="anime-carousel" id="animeCarousel"></div>
        <div class="carousel-progress" id="carouselProgress"></div>
      </div>
    </div>
  </section>

  <!-- Continue Watching Section -->
  <section class="continue-watching-section" id="continue-watching" style="display: none;">
    <div class="container">
      <div class="continue-watching-header fade-in">
        <h2>Continue Watching</h2>
        <div class="continue-controls">
          <button class="delete-history-btn" id="deleteHistoryBtn" title="Delete all history">
            <i class="fas fa-trash"></i>
          </button>
          <div class="continue-toggle">
            <a href="#" class="continue-view-all" id="continueViewAllBtn">
              View All
              <i class="fas fa-chevron-right"></i>
            </a>
            <a href="#" class="continue-view-all continue-view-less" id="continueViewLessBtn">
              View Less
              <i class="fas fa-chevron-up"></i>
            </a>
          </div>
        </div>
      </div>

      <div class="continue-grid" id="continueGrid"></div>
    </div>
  </section>

  <!-- Today's Releases Section -->
  <section class="today-releases-section" id="today-releases">
    <div class="container">
      <div class="today-releases-header fade-in">
        <h2>Today's Releases</h2>
        <div class="view-toggle">
          <a href="#" class="view-all" id="viewAllBtn">
            View All
            <i class="fas fa-chevron-right"></i>
          </a>
          <a href="#" class="view-all view-less" id="viewLessBtn">
            View Less
            <i class="fas fa-chevron-up"></i>
          </a>
        </div>
      </div>

      <div class="anime-grid" id="todayReleasesGrid"></div>
    </div>
  </section>

  <!-- Featured Anime Section -->
  <section class="anime-section" id="browse">
    <div class="container">
      <div class="section-header fade-in">
        <h2>Featured Anime</h2>
        <p>Curated selection of the most popular and highly-rated anime series</p>
      </div>

      <div class="anime-grid" id="featuredAnimeGrid"></div>
    </div>
  </section>

  <!-- Genres Section -->
  <section class="genres" id="genres">
    <div class="container">
      <div class="section-header fade-in">
        <h2>Browse by Genre</h2>
        <p>Explore anime from your favorite categories</p>
      </div>

      <div class="genres-grid">
        <div class="genre-card fade-in delay-1">
          <div class="genre-icon">
            <i class="fas fa-fist-raised"></i>
          </div>
          <h3>Action</h3>
          <div class="genre-count">1,240 titles</div>
        </div>
        <div class="genre-card fade-in delay-2">
          <div class="genre-icon">
            <i class="fas fa-laugh"></i>
          </div>
          <h3>Comedy</h3>
          <div class="genre-count">980 titles</div>
        </div>
        <div class="genre-card fade-in delay-3">
          <div class="genre-icon">
            <i class="fas fa-heart"></i>
          </div>
          <h3>Romance</h3>
          <div class="genre-count">750 titles</div>
        </div>
        <div class="genre-card fade-in">
          <div class="genre-icon">
            <i class="fas fa-ghost"></i>
          </div>
          <h3>Horror</h3>
          <div class="genre-count">420 titles</div>
        </div>
        <div class="genre-card fade-in delay-1">
          <div class="genre-icon">
            <i class="fas fa-rocket"></i>
          </div>
          <h3>Sci-Fi</h3>
          <div class="genre-count">680 titles</div>
        </div>
        <div class="genre-card fade-in delay-2">
          <div class="genre-icon">
            <i class="fas fa-magic"></i>
          </div>
          <h3>Fantasy</h3>
          <div class="genre-count">890 titles</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-about">
          <div class="footer-logo">
            <div class="logo-icon">
              <img src="Image & logo/kitsune logo.jpg" alt="Kitsune Logo"
                style="width: 100%; height: 100%; object-fit: contain;">
            </div>
            <div class="logo-text">Kitsune</div>
          </div>
          <p>Kitsune is the premier destination for anime streaming, offering thousands of titles in high quality with a
            seamless viewing experience.</p>
          <div class="social-links">
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-discord"></i></a>
          </div>
        </div>

        <div class="footer-column">
          <h3>Browse</h3>
          <ul class="footer-links">
            <li><a href="#">Popular Anime</a></li>
            <li><a href="#">New Releases</a></li>
            <li><a href="#">Top Rated</a></li>
            <li><a href="#">Upcoming</a></li>
            <li><a href="#">Movies</a></li>
          </ul>
        </div>

        <div class="footer-column">
          <h3>Support</h3>
          <ul class="footer-links">
            <li><a href="#">Help Center</a></li>
            <li><a href="#">Contact Us</a></li>
            <li><a href="#">FAQ</a></li>
            <li><a href="#">System Status</a></li>
            <li><a href="#">Feedback</a></li>
          </ul>
        </div>

        <div class="footer-column">
          <h3>Legal</h3>
          <ul class="footer-links">
            <li><a href="#">Terms of Service</a></li>
            <li><a href="#">Privacy Policy</a></li>
            <li><a href="#">Cookie Policy</a></li>
            <li><a href="#">Copyright</a></li>
            <li><a href="#">Legal Notice</a></li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <p>&copy; 2023 Kitsune Streaming. All rights reserved. Anime content is property of their respective owners.</p>
      </div>
    </div>
  </footer>
  <script>
    // DOM Elements
    const searchIconBtn = document.getElementById('searchIconBtn');
    const searchIcon = searchIconBtn.querySelector('i');
    const searchBox = document.getElementById('searchBox');
    const searchInput = document.getElementById('searchInput');
    const searchCloseBtn = document.getElementById('searchCloseBtn');
    const searchResults = document.getElementById('searchResults');
    const searchBackdrop = document.getElementById('searchBackdrop');
    const featuredAnimeGrid = document.getElementById('featuredAnimeGrid');
    const todayReleasesGrid = document.getElementById('todayReleasesGrid');
    const animeCarousel = document.getElementById('animeCarousel');
    const carouselProgress = document.getElementById('carouselProgress');
    const viewAllBtn = document.getElementById('viewAllBtn');
    const viewLessBtn = document.getElementById('viewLessBtn');

    // Continue Watching Elements
    const continueSection = document.getElementById('continue-watching');
    const continueGrid = document.getElementById('continueGrid');
    const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
    const continueViewAllBtn = document.getElementById('continueViewAllBtn');
    const continueViewLessBtn = document.getElementById('continueViewLessBtn');

    // Theme Toggle Elements
    const themeToggle = document.getElementById('themeToggle');

    // Profile Modal Elements
    const profileBtn = document.getElementById('profileBtn');
    const profileModal = document.getElementById('profileModal');
    const profileClose = document.getElementById('profileClose');
    const profileImage = document.getElementById('profileImage');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileImageEdit = document.getElementById('profileImageEdit');
    const profileImageInput = document.getElementById('profileImageInput');
    const profileDisplayName = document.getElementById('profileDisplayName');
    const profileUsername = document.getElementById('profileUsername');
    const profileEmail = document.getElementById('profileEmail');
    const profileJoinDate = document.getElementById('profileJoinDate');
    const signOutBtn = document.getElementById('signOutBtn');

    // Carousel variables
    let currentSlide = 0;
    let slideInterval;
    let isDragging = false;
    let startPos = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    let animationID;

    // Global variable to store anime data
    let animeData = [];

    // State for today's releases view
    let isTodayReleasesExpanded = false;

    // State for continue watching view
    let isContinueExpanded = false;

    // ===== CONTINUE WATCHING FUNCTIONS =====

    // Initialize Continue Watching from localStorage
    function initContinueWatching() {
      // Get watch history from localStorage
      const watchHistory = getWatchHistory();

      // If no history, hide the section
      if (watchHistory.length === 0) {
        continueSection.style.display = 'none';
        return;
      }

      // Show the section
      continueSection.style.display = 'block';

      // Populate continue watching grid (show only first 6)
      populateContinueGrid(watchHistory.slice(0, 6));

      // Reset expanded state
      isContinueExpanded = false;
      continueViewAllBtn.style.display = 'flex';
      continueViewLessBtn.style.display = 'none';
    }

    // Get watch history from localStorage
    function getWatchHistory() {
      try {
        const history = JSON.parse(localStorage.getItem('kitsune_watch_history') || '[]');
        return history;
      } catch (e) {
        console.error('Error loading watch history:', e);
        return [];
      }
    }

    // Save watch history to localStorage
    function saveWatchHistory(history) {
      localStorage.setItem('kitsune_watch_history', JSON.stringify(history));
    }

    // Add anime to watch history
    function addToWatchHistory(anime, episode, progress) {
      const history = getWatchHistory();

      // Remove if already exists
      const existingIndex = history.findIndex(item => item.title === anime.title);
      if (existingIndex !== -1) {
        history.splice(existingIndex, 1);
      }

      // Add to beginning (most recent first)
      history.unshift({
        title: anime.title,
        image: anime.image,
        genre: anime.genre,
        episode: episode,
        progress: progress,
        link: anime.link,
        timestamp: new Date().getTime()
      });

      // Keep only last 50 items
      const trimmedHistory = history.slice(0, 50);

      // Save to localStorage
      saveWatchHistory(trimmedHistory);

      // Refresh continue watching section
      initContinueWatching();
    }

    // Delete all history
    // Delete all history with toast notification (no confirmation)
    function deleteAllHistory() {
      // Delete history
      localStorage.removeItem('kitsune_watch_history');

      // Refresh continue watching section
      initContinueWatching();

      // Show toast notification
      showToast('Watch history deleted', 'success');
    }

    // Toast notification function
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toastNotification');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = toast.querySelector('i');

      // Set message
      toastMessage.textContent = message;

      // Set icon based on type
      if (type === 'success') {
        toastIcon.className = 'fas fa-check-circle';
        toast.className = 'toast-notification success';
      } else if (type === 'error') {
        toastIcon.className = 'fas fa-exclamation-circle';
        toast.className = 'toast-notification error';
      } else {
        toastIcon.className = 'fas fa-info-circle';
        toast.className = 'toast-notification info';
      }

      // Show toast
      toast.classList.add('show');

      // Hide after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Optional: Add undo functionality (if you want)
    let lastDeletedHistory = null;

    // Delete all history with undo option
    function deleteAllHistoryWithUndo() {
      // Save current history for potential undo
      lastDeletedHistory = getWatchHistory();

      // Delete history
      localStorage.removeItem('kitsune_watch_history');

      // Refresh continue watching section
      initContinueWatching();

      // Show toast with undo button
      showToastWithUndo('Watch history deleted');
    }

    // Toast with undo button
    function showToastWithUndo(message) {
      const toast = document.getElementById('toastNotification');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = toast.querySelector('i');

      // Create undo button if it doesn't exist
      let undoBtn = document.getElementById('toastUndoBtn');
      if (!undoBtn) {
        undoBtn = document.createElement('button');
        undoBtn.id = 'toastUndoBtn';
        undoBtn.innerHTML = 'UNDO';
        undoBtn.style.marginLeft = '15px';
        undoBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        undoBtn.style.border = 'none';
        undoBtn.style.color = 'white';
        undoBtn.style.padding = '5px 15px';
        undoBtn.style.borderRadius = '50px';
        undoBtn.style.cursor = 'pointer';
        undoBtn.style.fontWeight = '600';
        undoBtn.style.fontSize = '0.9rem';
        undoBtn.style.transition = 'all 0.2s ease';

        undoBtn.addEventListener('mouseenter', function () {
          this.style.background = 'rgba(255, 255, 255, 0.3)';
        });

        undoBtn.addEventListener('mouseleave', function () {
          this.style.background = 'rgba(255, 255, 255, 0.2)';
        });

        undoBtn.addEventListener('click', function () {
          if (lastDeletedHistory) {
            saveWatchHistory(lastDeletedHistory);
            initContinueWatching();
            showToast('History restored', 'info');
            lastDeletedHistory = null;
          }
          toast.classList.remove('show');
        });

        toast.appendChild(undoBtn);
      }

      // Set message
      toastMessage.textContent = message;

      // Set icon and class
      toastIcon.className = 'fas fa-info-circle';
      toast.className = 'toast-notification info';

      // Show toast
      toast.classList.add('show');

      // Auto hide after 5 seconds (longer for undo option)
      setTimeout(() => {
        toast.classList.remove('show');
        // Remove undo button when toast hides
        if (undoBtn && undoBtn.parentNode) {
          undoBtn.remove();
        }
      }, 5000);
    }

    // Populate continue watching grid
    function populateContinueGrid(history) {
      continueGrid.innerHTML = '';

      history.forEach(item => {
        const continueCard = createContinueCard(item);
        continueGrid.appendChild(continueCard);
      });
    }

    // Create continue watching card
    function createContinueCard(item) {
      const card = document.createElement('div');
      card.className = 'continue-card';

      // Format time ago
      const timeAgo = getTimeAgo(item.timestamp);

      card.innerHTML = `
        <div class="continue-image">
          <img src="${item.image}" alt="${item.title}" onerror="this.src='https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
          <div class="continue-progress">
            <div class="continue-progress-bar" style="width: ${item.progress}%"></div>
          </div>
        </div>
        <div class="continue-content">
          <h3>${item.title}</h3>
          <div class="continue-episode">Episode ${item.episode}</div>
          <div class="continue-time">
            <span><i class="fas fa-clock"></i> ${timeAgo}</span>
            <span>${item.progress}%</span>
          </div>
        </div>
      `;

      // Add click event to continue watching
      card.addEventListener('click', function () {
        window.location.href = item.link;
      });

      return card;
    }

    // Get time ago string
    function getTimeAgo(timestamp) {
      const now = new Date().getTime();
      const diff = now - timestamp;

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 60) {
        return `${minutes}m ago`;
      } else if (hours < 24) {
        return `${hours}h ago`;
      } else {
        return `${days}d ago`;
      }
    }

    // Expand continue watching (show all history)
    function expandContinueWatching() {
      if (isContinueExpanded) return;

      isContinueExpanded = true;

      // Hide view all button, show view less button
      continueViewAllBtn.style.display = 'none';
      continueViewLessBtn.style.display = 'flex';

      // Get all watch history
      const watchHistory = getWatchHistory();

      // Populate grid with all history
      populateContinueGrid(watchHistory);
    }

    // Collapse continue watching (show only first 6)
    function collapseContinueWatching() {
      if (!isContinueExpanded) return;

      isContinueExpanded = false;

      // Hide view less button, show view all button
      continueViewLessBtn.style.display = 'none';
      continueViewAllBtn.style.display = 'flex';

      // Get watch history and show only first 6
      const watchHistory = getWatchHistory().slice(0, 6);
      populateContinueGrid(watchHistory);
    }

    // ===== THEME SWITCHING FUNCTIONALITY =====
    function initializeThemeToggle() {
      // Check saved theme from localStorage
      const savedTheme = localStorage.getItem('kitsune_theme');

      // Set initial state of toggle
      if (savedTheme === 'light') {
        themeToggle.checked = true;
        document.documentElement.setAttribute('data-theme', 'light');
      } else {
        themeToggle.checked = false;
        document.documentElement.setAttribute('data-theme', 'dark');
      }

      // Add event listener for theme toggle
      themeToggle.addEventListener('change', function () {
        if (this.checked) {
          // Switch to light theme
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('kitsune_theme', 'light');
          console.log('Theme switched to: Light');
        } else {
          // Switch to dark theme
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('kitsune_theme', 'dark');
          console.log('Theme switched to: Dark');
        }
      });
    }

    // Header scroll effect
    window.addEventListener('scroll', function () {
      const header = document.getElementById('header');
      if (window.scrollY > 100) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Mobile menu toggle
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.querySelector('.nav-links');

    hamburger.addEventListener('click', function () {
      navLinks.classList.toggle('active');
      hamburger.classList.toggle('active');
    });

    // ===== FIXED SEARCH FUNCTIONALITY =====
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Desktop Search Functionality
    function openDesktopSearch() {
      searchBox.classList.add('expanded');
      searchIconBtn.classList.add('active');
      searchIconBtn.classList.add('hidden');
      searchInput.focus();
    }

    function closeDesktopSearch() {
      searchBox.classList.remove('expanded');
      searchIconBtn.classList.remove('active');
      searchIconBtn.classList.remove('hidden');
      searchResults.classList.remove('active');
      searchInput.value = '';
    }

    // Mobile Search Functionality
    function openMobileSearch() {
      searchBox.classList.add('expanded');
      searchIconBtn.classList.add('active');
      searchIconBtn.classList.add('hidden');
      searchBackdrop.classList.add('active');
      searchInput.focus();

      // On mobile, change search icon to X
      searchIcon.classList.remove('fa-search');
      searchIcon.classList.add('fa-times');

      document.body.style.overflow = 'hidden';
    }

    function closeMobileSearch() {
      searchBox.classList.remove('expanded');
      searchIconBtn.classList.remove('active');
      searchIconBtn.classList.remove('hidden');
      searchBackdrop.classList.remove('active');
      searchResults.classList.remove('active');
      searchInput.value = '';

      // On mobile, change X back to search icon
      searchIcon.classList.remove('fa-times');
      searchIcon.classList.add('fa-search');

      document.body.style.overflow = 'auto';
    }

    // Search icon click handler
    searchIconBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      const isExpanded = searchBox.classList.contains('expanded');

      if (isMobile()) {
        if (!isExpanded) {
          openMobileSearch();
        } else {
          closeMobileSearch();
        }
      } else {
        if (!isExpanded) {
          openDesktopSearch();
        } else {
          closeDesktopSearch();
        }
      }
    });

    // Search close button handler (INSIDE search box)
    searchCloseBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();

      if (isMobile()) {
        closeMobileSearch();
      } else {
        closeDesktopSearch();
      }
    });

    // Close search when clicking backdrop (mobile only)
    searchBackdrop.addEventListener('click', function () {
      if (isMobile()) {
        closeMobileSearch();
      }
    });

    // Close search on Escape key
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape' && searchBox.classList.contains('expanded')) {
        if (isMobile()) {
          closeMobileSearch();
        } else {
          closeDesktopSearch();
        }
      }
    });

    // Search input functionality
    searchInput.addEventListener('input', function () {
      performSearch(this.value);
    });

    // Close search when clicking outside (desktop only)
    document.addEventListener('click', function (event) {
      if (isMobile()) return;

      const isClickInsideSearchContainer = event.target.closest('.search-container');
      const isSearchBoxExpanded = searchBox.classList.contains('expanded');

      if (!isClickInsideSearchContainer && isSearchBoxExpanded) {
        closeDesktopSearch();
      }
    });

    // Profile Modal functionality
    function initProfileModal() {
      // Load user data from localStorage
      const userData = JSON.parse(localStorage.getItem('kitsune_user') || '{}');

      console.log('User Data:', userData);

      // Set profile data
      if (userData.displayName) {
        profileDisplayName.textContent = userData.displayName;
        document.querySelector('.profile-name').textContent = userData.displayName;
      } else if (userData.name) {
        profileDisplayName.textContent = userData.name;
        document.querySelector('.profile-name').textContent = userData.name;
      }

      if (userData.email) {
        profileEmail.textContent = userData.email;
      }

      // Remove extra @ from username
      if (userData.username) {
        const cleanUsername = userData.username.replace(/^@+/, '');
        profileUsername.textContent = `@${cleanUsername}`;
      } else if (userData.email) {
        const usernameFromEmail = userData.email.split('@')[0];
        profileUsername.textContent = `@${usernameFromEmail}`;
      } else {
        profileUsername.textContent = '@user';
      }

      // Set profile image
      const savedProfileImage = localStorage.getItem('kitsune_profile_image');

      if (savedProfileImage) {
        setProfileImage(savedProfileImage);
      } else if (userData.photoURL) {
        setProfileImage(userData.photoURL);
        localStorage.setItem('kitsune_profile_image', userData.photoURL);
      } else if (userData.picture) {
        setProfileImage(userData.picture);
        localStorage.setItem('kitsune_profile_image', userData.picture);
      } else if (userData.avatar) {
        setProfileImage(userData.avatar);
        localStorage.setItem('kitsune_profile_image', userData.avatar);
      } else {
        setDefaultAvatar();
      }

      // Set Member Since from first login date
      const firstLoginDate = localStorage.getItem('kitsune_first_login_date') || new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      profileJoinDate.textContent = firstLoginDate;

      // Also update user data if needed
      if (!userData.joinDate) {
        const updatedUserData = {
          ...userData,
          joinDate: firstLoginDate
        };
        localStorage.setItem('kitsune_user', JSON.stringify(updatedUserData));
      }
    }

    // Helper function to set profile image
    function setProfileImage(imageUrl) {
      profileImage.src = imageUrl;
      profileAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
    }

    // Helper function for default avatar
    function setDefaultAvatar() {
      const displayName = document.getElementById('profileDisplayName').textContent;
      const initials = displayName ? displayName.charAt(0).toUpperCase() : 'U';

      profileAvatar.innerHTML = `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--primary); color: white; font-weight: 600; font-size: 0.9rem;">${initials}</div>`;
      profileImage.src = '';
    }

    // Open profile modal
    profileBtn.addEventListener('click', function (e) {
      e.preventDefault();
      profileModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    });

    // Close profile modal
    profileClose.addEventListener('click', function () {
      profileModal.classList.remove('active');
      document.body.style.overflow = 'auto';
    });

    // Close modal when clicking outside
    profileModal.addEventListener('click', function (e) {
      if (e.target === profileModal) {
        profileModal.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
    });

    // Profile image change functionality
    profileImageEdit.addEventListener('click', function () {
      profileImageInput.click();
    });

    profileImageInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (event) {
          const imageUrl = event.target.result;
          profileImage.src = imageUrl;
          profileAvatar.innerHTML = `<img src="${imageUrl}" alt="Profile">`;
          localStorage.setItem('kitsune_profile_image', imageUrl);
        };
        reader.readAsDataURL(file);
      }
    });

    // Sign out functionality
    signOutBtn.addEventListener('click', function () {
      localStorage.removeItem('kitsune_user');
      localStorage.removeItem('kitsune_profile_image');
      window.location.href = 'signin.html';
    });

    // Extract episode number from type field
    function extractEpisodeNumber(typeString) {
      if (!typeString) return 0;
      const episodeMatch = typeString.match(/Ep\s*(\d+)/i);
      return episodeMatch ? parseInt(episodeMatch[1]) : 0;
    }

    // Enhanced episode status checker with completed support
    function checkEpisodeStatus(anime) {
      // Priority 1: Check if anime is completed
      if (anime.status === 'completed') {
        return 'COMPLETED';
      }

      // Priority 2: If anime has a new episode, show "NEW EP"
      if (anime.hasNewEpisode) {
        return 'NEW EP';
      }

      // Priority 3: If anime has more than 3 episodes, show "ONGOING"
      const episodeNumber = extractEpisodeNumber(anime.type);
      if (episodeNumber > 3) {
        return 'ONGOING';
      }

      // Priority 4: Otherwise show "NEW"
      return 'NEW';
    }

    // ===== FIXED: Smart Today's Releases Management =====
    // This function now preserves last updated anime until new uploads
    function manageTodaysReleases(newAnimeData) {
      const trackingKey = 'kitsune_episode_tracking_v2';
      const todayKey = 'kitsune_today_releases';
      const lastUpdateTimestampKey = 'kitsune_last_update_timestamp';
      const releaseHistoryKey = 'kitsune_release_history';

      // Get current episode tracking
      let episodeTracking = {};
      try {
        episodeTracking = JSON.parse(localStorage.getItem(trackingKey) || '{}');
      } catch (e) {
        episodeTracking = {};
      }

      // Get today's releases from storage
      let todaysReleases = [];
      try {
        todaysReleases = JSON.parse(localStorage.getItem(todayKey) || '[]');
      } catch (e) {
        todaysReleases = [];
      }

      // Get release history (all previously updated anime)
      let releaseHistory = [];
      try {
        releaseHistory = JSON.parse(localStorage.getItem(releaseHistoryKey) || '[]');
      } catch (e) {
        releaseHistory = [];
      }

      // Get last update timestamp
      const lastUpdateTime = localStorage.getItem(lastUpdateTimestampKey) || 0;
      const currentTime = new Date().getTime();

      // Track which anime have new episodes in this data load
      const animeWithNewEpisodes = [];
      const processedAnime = newAnimeData.map(anime => {
        const currentEpisode = extractEpisodeNumber(anime.type);
        const previousEpisode = episodeTracking[anime.title] || 0;

        // Check if this is a new episode
        const isNewEpisode = currentEpisode > previousEpisode;

        if (isNewEpisode) {
          console.log(` NEW EPISODE: ${anime.title} - Ep ${previousEpisode}  Ep ${currentEpisode}`);
          animeWithNewEpisodes.push(anime.title);
          anime.hasNewEpisode = true;

          // Add to release history if not already there
          if (!releaseHistory.includes(anime.title)) {
            releaseHistory.unshift(anime.title);
          }
        } else {
          anime.hasNewEpisode = false;
        }

        // Update tracking with current episode
        episodeTracking[anime.title] = currentEpisode;

        return anime;
      });

      // ===== UPDATED LOGIC: Preserve last updated anime =====
      if (animeWithNewEpisodes.length > 0) {
        // This is a new upload - update today's releases
        console.log('New episodes detected! Updating Today\'s Releases');

        // Add new episode anime to the top
        animeWithNewEpisodes.forEach(title => {
          // Remove if already exists (to avoid duplicates)
          todaysReleases = todaysReleases.filter(t => t !== title);
          // Add to beginning
          todaysReleases.unshift(title);
        });

        // Update last update timestamp
        localStorage.setItem(lastUpdateTimestampKey, currentTime.toString());

        // Update release history (keep last 20 releases)
        releaseHistory = [...new Set([...animeWithNewEpisodes, ...releaseHistory])].slice(0, 20);
        localStorage.setItem(releaseHistoryKey, JSON.stringify(releaseHistory));

        console.log('Added new episodes to top:', animeWithNewEpisodes);
      } else {
        // No new episodes - KEEP EXISTING TODAY'S RELEASES
        console.log('No new episodes detected - preserving Today\'s Releases');

        // If today's releases is empty (first time), populate with some content
        if (todaysReleases.length === 0) {
          console.log('First time - populating Today\'s Releases');

          // Get all ongoing anime
          const allOngoingAnime = processedAnime.filter(anime => anime.status !== 'completed');

          // Sort by episode number (highest first) and then alphabetically
          const sortedAnime = [...allOngoingAnime].sort((a, b) => {
            const episodeA = extractEpisodeNumber(a.type);
            const episodeB = extractEpisodeNumber(b.type);

            // First sort by episode number (descending)
            if (episodeB !== episodeA) {
              return episodeB - episodeA;
            }

            // Then sort alphabetically
            return a.title.localeCompare(b.title);
          });

          // Take first 6
          todaysReleases = sortedAnime.slice(0, 6).map(anime => anime.title);

          // Update last update timestamp
          localStorage.setItem(lastUpdateTimestampKey, currentTime.toString());
        }
      }

      // Ensure we have exactly 6 anime for the initial view
      if (todaysReleases.length < 6) {
        const neededCount = 6 - todaysReleases.length;

        // Get all ongoing anime
        const allOngoingAnime = processedAnime.filter(anime => anime.status !== 'completed');

        // Filter out anime already in today's list
        const availableAnime = allOngoingAnime.filter(anime =>
          !todaysReleases.includes(anime.title)
        );

        // Sort by episode number (highest first) and then alphabetically
        const sortedAnime = [...availableAnime].sort((a, b) => {
          const episodeA = extractEpisodeNumber(a.type);
          const episodeB = extractEpisodeNumber(b.type);

          // First sort by episode number (descending)
          if (episodeB !== episodeA) {
            return episodeB - episodeA;
          }

          // Then sort alphabetically
          return a.title.localeCompare(b.title);
        });

        // Add the top anime to reach 6
        const additionalTitles = sortedAnime.slice(0, neededCount).map(anime => anime.title);
        todaysReleases = [...todaysReleases, ...additionalTitles];

        console.log('Filled with additional anime:', additionalTitles);
      }

      // Always keep exactly 6 anime for initial view
      todaysReleases = todaysReleases.slice(0, 6);

      // Save updated tracking and today's releases
      localStorage.setItem(trackingKey, JSON.stringify(episodeTracking));
      localStorage.setItem(todayKey, JSON.stringify(todaysReleases));

      console.log('Final today releases (6 total):', todaysReleases);
      console.log('Release history:', releaseHistory);

      return {
        animeData: processedAnime,
        todaysReleases: todaysReleases
      };
    }

    // ===== Get Today's Releases from storage =====
    function getTodaysReleasesFromStorage(allAnime) {
      const todayKey = 'kitsune_today_releases';

      try {
        const storedTitles = JSON.parse(localStorage.getItem(todayKey) || '[]');
        console.log('Stored today releases titles:', storedTitles);

        // Create a map for quick lookup
        const animeMap = new Map();
        allAnime.forEach(anime => {
          animeMap.set(anime.title, anime);
        });

        // Get anime objects for stored titles
        const todaysAnime = [];
        for (const title of storedTitles) {
          if (animeMap.has(title)) {
            todaysAnime.push(animeMap.get(title));
          }
        }

        console.log('Today releases from storage:', todaysAnime.length, 'anime');
        return todaysAnime;
      } catch (e) {
        console.error('Error loading today releases:', e);
        return [];
      }
    }

    // ===== Get Last Two Days Releases =====
    function getLastTwoDaysReleases(allAnime) {
      const releaseHistoryKey = 'kitsune_release_history';

      try {
        // Get release history (anime that had new episodes in the last two days)
        const releaseHistory = JSON.parse(localStorage.getItem(releaseHistoryKey) || '[]');

        if (releaseHistory.length === 0) {
          // If no history, return all anime sorted by episode number
          return [...allAnime]
            .filter(anime => anime.status !== 'completed')
            .sort((a, b) => {
              const episodeA = extractEpisodeNumber(a.type);
              const episodeB = extractEpisodeNumber(b.type);
              return episodeB - episodeA;
            })
            .slice(0, 18);
        }

        // Create a map for quick lookup
        const animeMap = new Map();
        allAnime.forEach(anime => {
          animeMap.set(anime.title, anime);
        });

        // Get anime from release history
        const releases = [];
        for (const title of releaseHistory) {
          if (animeMap.has(title)) {
            releases.push(animeMap.get(title));
          }
        }

        // Add some ongoing anime if we have less than 18
        if (releases.length < 18) {
          const neededCount = 18 - releases.length;
          const existingTitles = releases.map(a => a.title);

          const otherAnime = allAnime
            .filter(anime => anime.status !== 'completed' && !existingTitles.includes(anime.title))
            .sort((a, b) => {
              const episodeA = extractEpisodeNumber(a.type);
              const episodeB = extractEpisodeNumber(b.type);
              return episodeB - episodeA;
            })
            .slice(0, neededCount);

          releases.push(...otherAnime);
        }

        return releases.slice(0, 18);
      } catch (e) {
        console.error('Error getting last two days releases:', e);
        return allAnime.slice(0, 18);
      }
    }

    // ===== Get Random Anime for Carousel (10 anime) =====
    function getRandomAnimeForCarousel(animeList, count = 10) {
      // Filter out completed anime for carousel
      const ongoingAnime = animeList.filter(anime => anime.status !== 'completed');

      if (ongoingAnime.length <= count) {
        return ongoingAnime;
      }

      // Fisher-Yates shuffle
      const shuffled = [...ongoingAnime];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }

      return shuffled.slice(0, count);
    }

    // ===== NEW: Get Featured Anime for Today (Changes once per day) =====
    function getFeaturedAnimeForToday(animeList, count = 30) {
      const storageKey = 'kitsune_featured_anime';
      const timestampKey = 'kitsune_featured_timestamp';

      // Get current time
      const currentTime = new Date().getTime();
      const oneDay = 24 * 60 * 60 * 1000; // 24 hours in milliseconds

      // Get stored featured anime and timestamp
      let storedFeatured = [];
      let lastUpdateTime = 0;

      try {
        storedFeatured = JSON.parse(localStorage.getItem(storageKey) || '[]');
        lastUpdateTime = localStorage.getItem(timestampKey) || 0;
      } catch (e) {
        console.error('Error loading featured anime:', e);
        storedFeatured = [];
        lastUpdateTime = 0;
      }

      // Check if we need to generate new featured anime
      if (currentTime - lastUpdateTime > oneDay || storedFeatured.length === 0) {
        console.log('Generating new featured anime for today');

        if (animeList.length <= count) {
          storedFeatured = animeList;
        } else {
          // Fisher-Yates shuffle
          const shuffled = [...animeList];
          for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
          }

          storedFeatured = shuffled.slice(0, count);
        }

        // Save to localStorage with current timestamp
        localStorage.setItem(storageKey, JSON.stringify(storedFeatured));
        localStorage.setItem(timestampKey, currentTime.toString());

        console.log('Featured anime saved for today:', storedFeatured.length, 'anime');
      } else {
        console.log('Using stored featured anime from today');
      }

      return storedFeatured;
    }

    // ===== Carousel Functions (5 seconds interval) =====
    function createCarousel(animeList) {
      if (!animeCarousel || animeList.length === 0) return;

      // Clear existing carousel
      animeCarousel.innerHTML = '';
      carouselProgress.innerHTML = '';

      // Get 10 random anime for carousel
      const carouselAnime = getRandomAnimeForCarousel(animeList, 10);

      // Create slides
      carouselAnime.forEach((anime, index) => {
        const slide = document.createElement('div');
        slide.className = 'carousel-slide';
        slide.dataset.index = index;

        // Determine badge text
        const badgeText = checkEpisodeStatus(anime);
        const badgeClass = badgeText === 'NEW EP' ? 'updated-badge' :
          badgeText === 'COMPLETED' ? 'updated-badge' :
            badgeText === 'ONGOING' ? 'new-badge' : 'new-badge';

        // Use actual rating from JSON data
        const rating = anime.rating || 8.5;

        slide.innerHTML = `
          <div class="carousel-backdrop" style="background-image: url('${anime.image}')"></div>
          <div class="carousel-image">
            <img src="${anime.image}" alt="${anime.title}" 
                 onerror="this.src='https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
          </div>
          <div class="carousel-content">
            <h3>${anime.title}</h3>
            <div class="carousel-meta">
              <div class="carousel-rating">
                <i class="fas fa-star"></i>
                <span>${rating}</span>
              </div>
              <div class="carousel-episode">${anime.type}</div>
            </div>
            <p class="carousel-description">${anime.genre}  Latest Release</p>
            <div class="carousel-actions">
              <button class="btn btn-primary" onclick="window.location.href='${anime.link}'">
                <i class="fas fa-play"></i>
                Watch Now
              </button>
            </div>
          </div>
          <div class="carousel-badge ${badgeClass}">${badgeText}</div>
        `;

        animeCarousel.appendChild(slide);

        // Create progress dot
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        dot.dataset.index = index;
        if (index === 0) dot.classList.add('active');

        dot.addEventListener('click', () => {
          goToSlide(index);
        });

        carouselProgress.appendChild(dot);
      });

      // Initialize carousel
      initCarousel();
    }

    function initCarousel() {
      // Stop any existing interval
      if (slideInterval) {
        clearInterval(slideInterval);
      }

      // 5 seconds interval
      slideInterval = setInterval(nextSlide, 5000);

      // Add touch/swipe events
      setupTouchEvents();
    }

    function nextSlide() {
      const slides = document.querySelectorAll('.carousel-slide');
      const dots = document.querySelectorAll('.progress-dot');

      if (slides.length === 0) return;

      currentSlide = (currentSlide + 1) % slides.length;
      updateCarousel();
    }

    function goToSlide(index) {
      currentSlide = index;
      updateCarousel();
      resetAutoSlide();
    }

    function updateCarousel() {
      const slides = document.querySelectorAll('.carousel-slide');
      const dots = document.querySelectorAll('.progress-dot');

      if (slides.length === 0) return;

      // Update carousel position
      animeCarousel.style.transform = `translateX(-${currentSlide * 100}%)`;

      // Update active dot
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });
    }

    function resetAutoSlide() {
      if (slideInterval) {
        clearInterval(slideInterval);
      }
      slideInterval = setInterval(nextSlide, 5000);
    }

    // Touch/swipe functionality
    function setupTouchEvents() {
      animeCarousel.addEventListener('touchstart', touchStart);
      animeCarousel.addEventListener('touchmove', touchMove);
      animeCarousel.addEventListener('touchend', touchEnd);

      animeCarousel.addEventListener('mousedown', mouseDown);
      animeCarousel.addEventListener('mousemove', mouseMove);
      animeCarousel.addEventListener('mouseup', mouseUp);
      animeCarousel.addEventListener('mouseleave', mouseLeave);
    }

    function touchStart(event) {
      startPos = getPositionX(event);
      isDragging = true;
      cancelAnimationFrame(animationID);
      clearInterval(slideInterval);
    }

    function touchMove(event) {
      if (!isDragging) return;
      const currentPosition = getPositionX(event);
      const diff = currentPosition - startPos;

      if (Math.abs(diff) > 10) {
        event.preventDefault();
      }
    }

    function touchEnd(event) {
      if (!isDragging) return;
      isDragging = false;

      const currentPosition = getPositionX(event);
      const diff = currentPosition - startPos;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          // Swipe right - go to previous slide
          currentSlide = currentSlide > 0 ? currentSlide - 1 : document.querySelectorAll('.carousel-slide').length - 1;
        } else {
          // Swipe left - go to next slide
          const slides = document.querySelectorAll('.carousel-slide');
          currentSlide = (currentSlide + 1) % slides.length;
        }
      }

      updateCarousel();
      resetAutoSlide();
    }

    function mouseDown(event) {
      startPos = event.clientX;
      isDragging = true;
      cancelAnimationFrame(animationID);
      clearInterval(slideInterval);
    }

    function mouseMove(event) {
      if (!isDragging) return;
      event.preventDefault();
    }

    function mouseUp(event) {
      if (!isDragging) return;
      isDragging = false;

      const currentPosition = event.clientX;
      const diff = currentPosition - startPos;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          // Swipe right - go to previous slide
          currentSlide = currentSlide > 0 ? currentSlide - 1 : document.querySelectorAll('.carousel-slide').length - 1;
        } else {
          // Swipe left - go to next slide
          const slides = document.querySelectorAll('.carousel-slide');
          currentSlide = (currentSlide + 1) % slides.length;
        }
      }

      updateCarousel();
      resetAutoSlide();
    }

    function mouseLeave() {
      if (isDragging) {
        isDragging = false;
        updateCarousel();
        resetAutoSlide();
      }
    }

    function getPositionX(event) {
      return event.type.includes('mouse') ? event.clientX : event.touches[0].clientX;
    }

    // Load anime data from JSON file
    async function loadAnimeData() {
      try {
        const response = await fetch('searchData.json');
        if (!response.ok) {
          throw new Error('Failed to load anime data');
        }
        const newAnimeData = await response.json();

        // Step 1: Manage today's releases with smart tracking
        const result = manageTodaysReleases(newAnimeData);
        animeData = result.animeData;

        // Step 2: Create carousel with 10 random anime
        createCarousel(animeData);

        // Step 3: Initialize Continue Watching
        initContinueWatching();

        // Step 4: Populate Today's Releases and Featured sections
        populateAnimeSections(result.todaysReleases);

        // Step 5: Setup view toggle buttons
        setupViewToggle();

        // Step 6: Setup continue watching buttons
        setupContinueWatchingButtons();

        // Example: Add a test item to watch history (for testing)
        // Uncomment this to test the feature
        /*
        if (animeData.length > 0) {
          addToWatchHistory(animeData[0], 5, 45);
          addToWatchHistory(animeData[1], 12, 78);
          addToWatchHistory(animeData[2], 3, 22);
        }
        */

      } catch (error) {
        console.error('Error loading anime data:', error);
        // Fallback: use JSON data directly
        const response = await fetch('searchData.json');
        const newAnimeData = await response.json();
        animeData = newAnimeData.map(anime => ({
          ...anime,
          episodeNumber: extractEpisodeNumber(anime.type)
        }));

        // Create carousel with fallback data
        createCarousel(animeData);
        initContinueWatching();
        populateAnimeSections([]);
        setupViewToggle();
        setupContinueWatchingButtons();
      }
    }

    // Setup Continue Watching buttons
    // Setup Continue Watching buttons
    function setupContinueWatchingButtons() {
      // View All button
      continueViewAllBtn.addEventListener('click', function (e) {
        e.preventDefault();
        expandContinueWatching();
      });

      // View Less button
      continueViewLessBtn.addEventListener('click', function (e) {
        e.preventDefault();
        collapseContinueWatching();
      });

      // Delete history button - OPTION 1: Simple toast (no confirmation)
      deleteHistoryBtn.addEventListener('click', function (e) {
        e.preventDefault();
        deleteAllHistory(); // No confirmation, just toast
      });

      // OPTION 2: Toast with undo button (uncomment to use this instead)
      /*
      deleteHistoryBtn.addEventListener('click', function (e) {
          e.preventDefault();
          deleteAllHistoryWithUndo(); // Toast with undo option
      });
      */
    }

    // ===== Setup View Toggle Buttons =====
    function setupViewToggle() {
      viewAllBtn.addEventListener('click', function (e) {
        e.preventDefault();
        expandTodayReleases();
      });

      viewLessBtn.addEventListener('click', function (e) {
        e.preventDefault();
        collapseTodayReleases();
      });
    }

    // ===== Expand Today's Releases (Show Last 2 Days) =====
    function expandTodayReleases() {
      if (isTodayReleasesExpanded) return;

      isTodayReleasesExpanded = true;

      // Hide view all button, show view less button
      viewAllBtn.style.display = 'none';
      viewLessBtn.style.display = 'flex';

      // Get last two days releases
      const lastTwoDaysAnime = getLastTwoDaysReleases(animeData);

      // Populate grid with expanded view
      todayReleasesGrid.innerHTML = '';
      lastTwoDaysAnime.slice(0, 18).forEach(anime => {
        const animeCard = createAnimeCard(anime);
        todayReleasesGrid.appendChild(animeCard);
      });

      // Add smooth scroll to section
      document.getElementById('today-releases').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // ===== Collapse Today's Releases (Show 6 Anime) =====
    function collapseTodayReleases() {
      if (!isTodayReleasesExpanded) return;

      isTodayReleasesExpanded = false;

      // Hide view less button, show view all button
      viewLessBtn.style.display = 'none';
      viewAllBtn.style.display = 'flex';

      // Get today's releases from storage
      const todaysReleases = getTodaysReleasesFromStorage(animeData);

      // Populate grid with collapsed view
      todayReleasesGrid.innerHTML = '';
      todaysReleases.slice(0, 6).forEach(anime => {
        const animeCard = createAnimeCard(anime);
        todayReleasesGrid.appendChild(animeCard);
      });
    }

    // ===== FIXED: Populate Today's Releases (ALWAYS show exactly 6 anime initially) =====
    function populateTodayReleases(storedAnimeList) {
      todayReleasesGrid.innerHTML = '';

      console.log('Stored anime for Today Releases:', storedAnimeList.length, 'anime');

      // Start with stored anime (anime with new episodes)
      let todaysAnime = [...storedAnimeList];

      // If we have less than 6, fill with ongoing anime sorted by highest episode
      if (todaysAnime.length < 6) {
        const neededCount = 6 - todaysAnime.length;

        // Get all ongoing anime
        const allOngoingAnime = animeData.filter(anime => anime.status !== 'completed');

        // Get titles already in today's list
        const existingTitles = todaysAnime.map(anime => anime.title);

        // Filter out anime already in today's list
        const availableAnime = allOngoingAnime.filter(anime => !existingTitles.includes(anime.title));

        // Sort by episode number (highest first)
        const sortedByEpisode = [...availableAnime].sort((a, b) => {
          const episodeA = extractEpisodeNumber(a.type);
          const episodeB = extractEpisodeNumber(b.type);
          return episodeB - episodeA; // Highest episode first
        });

        // Add the needed anime
        const additionalAnime = sortedByEpisode.slice(0, neededCount);
        todaysAnime = [...todaysAnime, ...additionalAnime];

        console.log('Added', additionalAnime.length, 'more anime to reach 6 total');
      }

      // Ensure we have exactly 6 for initial view
      todaysAnime = todaysAnime.slice(0, 6);

      console.log('Initial Today Releases (6 total):', todaysAnime.map(a => a.title));

      // Create cards for all 6 anime
      todaysAnime.forEach(anime => {
        const animeCard = createAnimeCard(anime);
        todayReleasesGrid.appendChild(animeCard);
      });

      // Reset view state
      isTodayReleasesExpanded = false;
      viewAllBtn.style.display = 'flex';
      viewLessBtn.style.display = 'none';
    }

    // Populate anime sections
    function populateAnimeSections(storedTodayTitles) {
      // ===== TODAY'S RELEASES =====
      // Get anime from storage (smartly managed)
      const todaysReleases = getTodaysReleasesFromStorage(animeData);
      populateTodayReleases(todaysReleases);

      // ===== FEATURED ANIME ===== (Now changes once per day)
      // Get featured anime for today (30 ANIME)
      const featuredAnime = getFeaturedAnimeForToday(animeData, 30);
      populateFeaturedAnime(featuredAnime);
    }

    // Populate Featured Anime (Changes once per day) - NOW SHOWS 30 ANIME
    function populateFeaturedAnime(animeList) {
      featuredAnimeGrid.innerHTML = '';

      // Limit to maximum 30 anime
      const limitedAnimeList = animeList.slice(0, 30);

      limitedAnimeList.forEach(anime => {
        const animeCard = createAnimeCard(anime);
        featuredAnimeGrid.appendChild(animeCard);
      });

      // If we have less than 30 anime, show a message
      if (limitedAnimeList.length < 30) {
        const emptyCard = document.createElement('div');
        emptyCard.className = 'anime-card empty-card';
        emptyCard.innerHTML = `
          <div class="card-image" style="background: var(--card-bg-color); display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-plus" style="font-size: 2rem; color: var(--text-tertiary);"></i>
          </div>
          <div class="card-content">
            <h3>More Coming Soon</h3>
            <p class="card-description">We're adding more amazing anime content regularly</p>
          </div>
        `;
        featuredAnimeGrid.appendChild(emptyCard);
      }
    }

    // Create anime card component
    function createAnimeCard(anime) {
      const animeCard = document.createElement('div');
      animeCard.className = 'anime-card fade-in';

      // Determine badge text based on status and updates
      const badgeText = checkEpisodeStatus(anime);
      const showBadge = true;

      // Determine badge class
      let badgeClass = 'new-badge';
      if (badgeText === 'NEW EP') {
        badgeClass = 'updated-badge';
      } else if (badgeText === 'COMPLETED') {
        badgeClass = 'updated-badge';
      } else if (badgeText === 'ONGOING') {
        badgeClass = 'new-badge';
      }

      // Use actual rating from JSON data
      const rating = anime.rating || 8.5;

      animeCard.innerHTML = `
        <div class="card-image">
          <img src="${anime.image}" alt="${anime.title}" onerror="this.src='https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
          ${showBadge ? `<div class="card-badge ${badgeClass}">${badgeText}</div>` : ''}
        </div>
        <div class="card-content">
          <h3>${anime.title}</h3>
          <div class="card-meta">
            <span>${anime.genre}</span>
            <div class="card-rating">
              <i class="fas fa-star"></i>
              <span>${rating}</span>
            </div>
          </div>
          <p class="card-description">${anime.type}</p>
        </div>
      `;

      // Add click event to navigate to anime page
      animeCard.addEventListener('click', function () {
        // Add to watch history when clicked (example: episode 1, progress 0%)
        addToWatchHistory(anime, 1, 0);
        window.location.href = anime.link;
      });

      return animeCard;
    }

    // Add resize listener to update on screen size changes
    window.addEventListener('resize', function () {
      if (animeData.length > 0) {
        // Re-populate sections to adjust grid layout
        const todaysReleases = getTodaysReleasesFromStorage(animeData);

        if (isTodayReleasesExpanded) {
          // If expanded, show last two days
          const lastTwoDaysAnime = getLastTwoDaysReleases(animeData);
          todayReleasesGrid.innerHTML = '';
          lastTwoDaysAnime.slice(0, 18).forEach(anime => {
            const animeCard = createAnimeCard(anime);
            todayReleasesGrid.appendChild(animeCard);
          });
        } else {
          // If collapsed, show today's releases
          populateTodayReleases(todaysReleases);
        }

        // Featured anime will stay the same as it's cached for the day
        const featuredAnime = getFeaturedAnimeForToday(animeData, 30);
        populateFeaturedAnime(featuredAnime);

        // Refresh continue watching
        initContinueWatching();
      }
    });

    // Search functionality
    function performSearch(query) {
      const normalizedQuery = query.toLowerCase().trim();

      if (normalizedQuery === '') {
        searchResults.classList.remove('active');
        return;
      }

      const filteredAnime = animeData.filter(anime => {
        return anime.title.toLowerCase().includes(normalizedQuery) ||
          anime.genre.toLowerCase().includes(normalizedQuery) ||
          anime.type.toLowerCase().includes(normalizedQuery);
      });

      displaySearchResults(filteredAnime);
    }

    // Display search results with ratings
    function displaySearchResults(results) {
      searchResults.innerHTML = '';

      if (results.length === 0) {
        searchResults.innerHTML = '<div class="no-results">No anime found matching your search</div>';
      } else {
        results.forEach(anime => {
          const resultItem = document.createElement('a');
          resultItem.className = 'search-result-item';
          resultItem.href = anime.link;

          // Determine badge text for search results
          const badgeText = checkEpisodeStatus(anime);
          const updateIndicator = badgeText === 'NEW EP' ? '<div class="search-update-indicator">NEW EP</div>' :
            badgeText === 'ONGOING' ? '<div class="search-update-indicator">ONGOING</div>' :
              badgeText === 'COMPLETED' ? '<div class="search-update-indicator">COMPLETED</div>' : '';

          // Use actual rating from JSON data
          const rating = anime.rating || 8.5;

          resultItem.innerHTML = `
            <div class="search-result-image">
              <img src="${anime.image}" alt="${anime.title}" onerror="this.src='https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
            </div>
            <div class="search-result-content">
              <div class="search-result-title">${anime.title} ${updateIndicator}</div>
              <div class="search-result-type">${anime.type}</div>
              <div class="search-result-meta">
                <span class="search-result-genre">${anime.genre}</span>
                <div class="search-result-rating">
                  <i class="fas fa-star"></i>
                  <span>${rating}</span>
                </div>
              </div>
            </div>
          `;

          // Add click event to add to watch history
          resultItem.addEventListener('click', function (e) {
            e.preventDefault();
            addToWatchHistory(anime, 1, 0);
            window.location.href = anime.link;
          });

          searchResults.appendChild(resultItem);
        });
      }

      searchResults.classList.add('active');
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize theme toggle
      initializeThemeToggle();

      // Initialize profile modal with user data
      initProfileModal();

      // Load anime data from JSON file
      loadAnimeData();

      // Animation on scroll
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver(function (entries) {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('fade-in');
          }
        });
      }, observerOptions);

      // Observe all elements with fade-in class
      document.querySelectorAll('.fade-in').forEach(el => {
        observer.observe(el);
      });

      // Add reset function to console for testing
      window.resetKitsuneTracking = function () {
        localStorage.removeItem('kitsune_episode_tracking_v2');
        localStorage.removeItem('kitsune_today_releases');
        localStorage.removeItem('kitsune_today_timestamp');
        localStorage.removeItem('kitsune_last_update_timestamp');
        localStorage.removeItem('kitsune_release_history');
        console.log('Episode tracking reset. Refreshing page...');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      };
      console.log('To reset episode tracking, run: resetKitsuneTracking()');

      // Add theme reset function
      window.resetKitsuneTheme = function () {
        localStorage.removeItem('kitsune_theme');
        console.log('Theme preference reset. Refreshing page...');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      };
      console.log('To reset theme preference, run: resetKitsuneTheme()');

      // Add featured anime reset function
      window.resetKitsuneFeatured = function () {
        localStorage.removeItem('kitsune_featured_anime');
        localStorage.removeItem('kitsune_featured_timestamp');
        console.log('Featured anime reset. New set will be generated on refresh...');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      };
      console.log('To reset featured anime (force new selection), run: resetKitsuneFeatured()');

      // Add watch history reset function
      window.resetKitsuneHistory = function () {
        localStorage.removeItem('kitsune_watch_history');
        console.log('Watch history reset. Refreshing page...');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      };
      console.log('To reset watch history, run: resetKitsuneHistory()');
    });
  </script>
</body>

</html>